@model NutriTrackData.Models.MealModel

@{
    ViewData["Title"] = "Create New Meal";
    var categories = ViewBag.Categories as List<NutriTrackData.Entities.MealCategory>;
    var availableProducts = ViewBag.AvailableProducts as List<NutriTrackData.Entities.Product>;
}

<h2>@ViewData["Title"]</h2>

<form method="post">
    <div class="form-group">
        <label for="Name">Meal Name</label>
        <input type="text" class="form-control" id="Name" name="Name" value="@Model.Name" required />
    </div>

    <div class="form-group">
        <label for="CategoryId">Category</label>
        <select class="form-control" id="CategoryId" name="CategoryId" required>
            @if (categories != null)
            {
                foreach (var category in categories)
                {
                    <option value="@category.CategoryId" selected="@(Model.CategoryId == category.CategoryId)">@category.Name</option>
                }
            }
        </select>
    </div>

    <div class="form-group">
        <label for="Products">Products</label>
        <div id="product-container">
            @for (int i = 0; i < Model.Products.Count; i++)
            {
                <div class="product-row">
                    <select class="form-control" name="Products[@i].ProductId" required>
                        <option value="">Select Product</option>
                        @if (availableProducts != null)
                        {
                            foreach (var product in availableProducts)
                            {
                                <option value="@product.Id" selected="@(Model.Products[i].ProductId == product.Id)">@product.Name</option>
                            }
                        }
                    </select>
                    <input type="number" class="form-control" name="Products[@i].Quantity" placeholder="Quantity (grams)" value="@Model.Products[i].Quantity" required />
                </div>
            }
        </div>
        <button type="button" class="btn btn-info" id="add-product-row">Add Product</button>
    </div>

    <button type="submit" class="btn btn-primary">Save Meal</button>
</form>

<script>
    var availableProducts = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.AvailableProducts));

    document.getElementById("add-product-row").addEventListener("click", function () {
        var productContainer = document.getElementById("product-container");
        var newProductRow = document.createElement("div");
        newProductRow.classList.add("product-row");

        var productSelect = document.createElement("select");
        productSelect.classList.add("form-control");
        productSelect.name = "Products[" + productContainer.children.length + "].ProductId";
        var placeholderOption = document.createElement("option");
        placeholderOption.value = "";
        placeholderOption.text = "Select Product";
        productSelect.appendChild(placeholderOption);

        availableProducts.forEach(function (product) {
            var option = document.createElement("option");
            option.value = product.Id;
            option.text = product.Name;
            productSelect.appendChild(option);
        });

        var quantityInput = document.createElement("input");
        quantityInput.classList.add("form-control");
        quantityInput.name = "Products[" + productContainer.children.length + "].Quantity";
        quantityInput.placeholder = "Quantity (grams)";
        quantityInput.type = "number";

        newProductRow.appendChild(productSelect);
        newProductRow.appendChild(quantityInput);

        productContainer.appendChild(newProductRow);
    });
</script>
